---
# Validate deployment

- name: Check service status
  systemd:
    name: "{{ broker_service_name }}"
  register: kafka_status

- name: Verify service is running
  assert:
    that:
      - kafka_status.status.ActiveState == "active"
    fail_msg: "Kafka Broker service is not running"
    success_msg: "Kafka Broker service is active"

- name: Check broker is responding
  shell: |
    {{ broker_install_dir }}/bin/kafka-broker-api-versions \
    --bootstrap-server localhost:{{ broker_client_port }} 2>/dev/null
  register: broker_check
  retries: 5
  delay: 10
  until: broker_check.rc == 0
  changed_when: false

- name: Display broker status
  debug:
    msg: |
      Broker: {{ ansible_fqdn }}
      ID: {{ broker_id }}
      Status: {{ kafka_status.status.ActiveState }}
      Port: {{ broker_client_port }}

- name: Check Prometheus metrics
  uri:
    url: "http://localhost:{{ prometheus_jmx_exporter_port }}/metrics"
    return_content: no
    status_code: 200
  register: prometheus_check
  failed_when: false
  when: prometheus_jmx_exporter_enabled | bool

- name: Display Prometheus status
  debug:
    msg: "Prometheus metrics: {{ 'AVAILABLE' if prometheus_check.status == 200 else 'NOT AVAILABLE' }}"
  when: prometheus_jmx_exporter_enabled | bool
