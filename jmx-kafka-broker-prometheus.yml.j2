---
# ==============================================================================
# Prometheus JMX Exporter Configuration for Confluent Kafka Broker
# Port: {{ prometheus_jmx_exporter_port }}
# Mirrors: roles/zookeeper/templates/jmx-zookeeper-prometheus.yml.j2 pattern
# ==============================================================================

hostPort: 127.0.0.1:{{ kafka_jmx_port }}
lowercaseOutputName: true
lowercaseOutputLabelNames: true

whitelistObjectNames:
  - "kafka.server:*"
  - "kafka.network:*"
  - "kafka.log:*"
  - "kafka.controller:*"
  - "kafka.coordinator.group:*"
  - "kafka.coordinator.transaction:*"
  - "java.lang:*"

rules:
  # Broker Topic Metrics
  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(.+), topic=(.+)><>OneMinuteRate'
    name: kafka_server_broker_topic_metrics_$1_one_minute_rate
    labels:
      topic: "$2"

  - pattern: 'kafka.server<type=BrokerTopicMetrics, name=(.+)><>OneMinuteRate'
    name: kafka_server_broker_topic_metrics_$1_one_minute_rate

  # Replica Manager
  - pattern: 'kafka.server<type=ReplicaManager, name=(.+)><>Value'
    name: kafka_server_replica_manager_$1

  # Request Handler Pool
  - pattern: 'kafka.server<type=KafkaRequestHandlerPool, name=(.+)><>OneMinuteRate'
    name: kafka_server_request_handler_pool_$1

  # Network Request Metrics
  - pattern: 'kafka.network<type=RequestMetrics, name=(.+), request=(.+)><>(.+):'
    name: kafka_network_request_metrics_$1
    labels:
      request: "$2"
      attribute: "$3"

  - pattern: 'kafka.network<type=SocketServer, name=(.+)><>Value'
    name: kafka_network_socket_server_$1

  # Controller Metrics
  - pattern: 'kafka.controller<type=KafkaController, name=(.+)><>Value'
    name: kafka_controller_$1

  - pattern: 'kafka.controller<type=ControllerStats, name=(.+)><>OneMinuteRate'
    name: kafka_controller_stats_$1_one_minute_rate

  # Leader Election
  - pattern: 'kafka.controller<type=ControllerStats, name=LeaderElectionRateAndTimeMs><>(.+):'
    name: kafka_controller_leader_election_$1

  # Log Metrics
  - pattern: 'kafka.log<type=LogFlushStats, name=(.+)><>(.+):'
    name: kafka_log_flush_stats_$1_$2

  - pattern: 'kafka.log<type=Log, name=(.+), topic=(.+), partition=(.+)><>Value'
    name: kafka_log_$1
    labels:
      topic: "$2"
      partition: "$3"

  # Consumer Group Coordinator
  - pattern: 'kafka.coordinator.group<type=GroupMetadataManager, name=(.+)><>Value'
    name: kafka_coordinator_group_metadata_manager_$1

  # JVM Memory
  - pattern: 'java.lang<type=Memory><HeapMemoryUsage>(.+)'
    name: jvm_memory_heap_$1_bytes
    type: GAUGE

  - pattern: 'java.lang<type=Memory><NonHeapMemoryUsage>(.+)'
    name: jvm_memory_nonheap_$1_bytes
    type: GAUGE

  # JVM GC
  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><>CollectionCount'
    name: jvm_gc_collection_count
    labels:
      gc: "$1"

  - pattern: 'java.lang<type=GarbageCollector, name=(.+)><>CollectionTime'
    name: jvm_gc_collection_time_ms
    labels:
      gc: "$1"

  # JVM Threads
  - pattern: 'java.lang<type=Threading><>(.+)'
    name: jvm_threads_$1
    type: GAUGE

  # OS
  - pattern: 'java.lang<type=OperatingSystem><>(.+):'
    name: jvm_os_$1

  # Catch-all
  - pattern: ".*"
