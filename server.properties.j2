#==============================================================
# Kafka Broker — server.properties
# Managed by Ansible Automation Platform — DO NOT EDIT MANUALLY
# Template: roles/broker/templates/server.properties.j2
#==============================================================

# ---- Server Config ----
broker.id = {{ broker_id }}

# ---- Listeners ----
listeners = SASL_SSL://{{ ansible_fqdn }}:{{ kafka_sasl_ssl_port }},TOKEN://{{ ansible_fqdn }}:{{ kafka_token_port }},AD://{{ ansible_fqdn }}:{{ kafka_ad_port }}
advertised.listeners = SASL_SSL://{{ ansible_fqdn }}:{{ kafka_sasl_ssl_port }},TOKEN://{{ ansible_fqdn }}:{{ kafka_token_port }},AD://{{ ansible_fqdn }}:{{ kafka_ad_port }}
listener.security.protocol.map = SASL_SSL:SASL_SSL,TOKEN:SASL_SSL,AD:SASL_SSL
listener.name.sasl_ssl.scram-sha-256.sasl.jaas.config = org.apache.kafka.common.security.scram.ScramLoginModule required \
   username="admin" \
   password=${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.sasl_ssl.scram-sha-256.sasl.jaas.config/org.apache.kafka.common.security.scram.ScramLoginModule/password};

# ---- Security ----
sasl.enabled.mechanisms = SCRAM-SHA-256
sasl.mechanism.inter.broker.protocol = SCRAM-SHA-256
security.inter.broker.protocol = SASL_SSL
ssl.truststore.location = {{ ssl_truststore_location }}
ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/ssl.truststore.password}
ssl.keystore.location = {{ ssl_keystore_location }}
ssl.keystore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/ssl.keystore.password}
ssl.key.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/ssl.key.password}

# ---- Rack / Zone ----
broker.rack = {{ broker_rack }}

# ---- Protocol Version ----
inter.broker.protocol.version = {{ inter_broker_protocol_version }}

# ---- Broker Tuning ----
num.network.threads = {{ num_network_threads }}
num.io.threads = {{ num_io_threads }}
socket.send.buffer.bytes = {{ socket_send_buffer_bytes }}
socket.receive.buffer.bytes = {{ socket_receive_buffer_bytes }}
socket.request.max.bytes = {{ socket_request_max_bytes }}
num.partitions = {{ num_partitions }}
num.recovery.threads.per.data.dir = {{ num_recovery_threads_per_data_dir }}
log.retention.hours = {{ log_retention_hours }}
log.segment.bytes = {{ log_segment_bytes }}
log.retention.check.interval.ms = {{ log_retention_check_interval_ms }}
group.initial.rebalance.delay.ms = {{ group_initial_rebalance_delay_ms }}
offset.topic.replication.factor = {{ offset_topic_replication_factor }}
transaction.state.log.replication.factor = {{ transaction_state_log_replication_factor }}
transaction.state.log.min.isr = {{ transaction_state_log_min_isr }}
auto.create.topics.enable = {{ auto_create_topics_enable }}
min.insync.replicas = {{ min_insync_replicas }}
replica.socket.receive.buffer.bytes = {{ replica_socket_receive_buffer_bytes }}
num.replica.fetchers = {{ num_replica_fetchers }}
confluent.metadata.default.api.timeout.ms = {{ confluent_metadata_default_api_timeout_ms }}

# ---- Log Directory ----
log.dirs = {{ broker_data_dir }}

# ---- Zookeeper ----
zookeeper.connect = {{ zookeeper_connect_dynamic | default(zookeeper_connect) }}
zookeeper.connection.timeout.ms = {{ zookeeper_connection_timeout_ms }}

# ---- Confluent Metrics Reporter ----
metric.reporters = io.confluent.metrics.reporter.ConfluentMetricsReporter
confluent.metrics.reporter.topic.retention.ms = {{ metrics_reporter_topic_retention_ms }}
confluent.metrics.reporter.bootstrap.servers = {{ bstring | default(metrics_reporter_bootstrap_servers) }}
confluent.metrics.reporter.security.protocol = SASL_SSL
confluent.metrics.reporter.ssl.truststore.location = {{ ssl_truststore_location }}
confluent.metrics.reporter.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.metrics.reporter.ssl.truststore.password}
confluent.metrics.reporter.sasl.mechanism = SCRAM-SHA-256
confluent.metrics.reporter.sasl.jaas.config = org.apache.kafka.common.security.scram.ScramLoginModule required \
  username="admin" \
  password=${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.metrics.reporter.sasl.jaas.config/org.apache.kafka.common.security.scram.ScramLoginModule/password};

# ---- TOKEN Listener (OAuth / MDS) ----
listener.name.token.ssl.truststore.location = {{ ssl_truststore_location }}
listener.name.token.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.token.ssl.truststore.password}
listener.name.token.ssl.keystore.location = {{ ssl_keystore_location }}
listener.name.token.ssl.keystore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.token.ssl.keystore.password}
listener.name.token.ssl.key.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.token.ssl.key.password}
listener.name.token.sasl.enabled.mechanisms = OAUTHBEARER
listener.name.token.oauthbearer.sasl.jaas.config = org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required publicKeyPath="{{ mds_public_key_path }}";
listener.name.token.oauthbearer.sasl.server.callback.handler.class = io.confluent.kafka.server.plugins.auth.token.TokenBearerValidatorCallbackHandler
listener.name.token.oauthbearer.sasl.login.callback.handler.class = io.confluent.kafka.server.plugins.auth.token.TokenBearerServerLoginCallbackHandler
listener.name.token.principal.builder.class = io.confluent.kafka.security.authenticator.OAuthKafkaPrincipalBuilder
listener.name.token.sasl.oauthbearer.jwks.endpoint.url = https://login.microsoftonline.com/{{ azure_tenant_id }}/discovery/v2.0/keys
listener.name.token.sasl.oauthbearer.token.endpoint.url = https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/v2.0/token
listener.name.token.sasl.oauthbearer.scope.claim.name = roles
listener.name.token.sasl.oauthbearer.sub.claim.name = sub
listener.name.token.sasl.oauthbearer.expected.audience = {{ server_client_id }}
listener.name.token.sasl.oauthbearer.expected.issuer = https://login.microsoftonline.com/{{ azure_tenant_id }}/v2.0

# ---- OIDC / SSO ----
confluent.oidc.idp.issuer = https://login.microsoftonline.com/{{ azure_tenant_id }}/v2.0
confluent.oidc.idp.jwks.endpoint.uri = https://login.microsoftonline.com/{{ azure_tenant_id }}/discovery/v2.0/keys
confluent.oidc.idp.authorize.base.endpoint.uri = https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/v2.0/authorize
confluent.oidc.idp.token.base.endpoint.uri = https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/v2.0/token
confluent.oidc.idp.client.id = {{ oidc_client_id }}
confluent.oidc.idp.client.secret = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.oidc.idp.client.secret}
confluent.oidc.idp.device.authorization.endpoint.uri = https://login.microsoftonline.com/{{ azure_tenant_id }}/oauth2/v2.0/devicecode
confluent.oidc.idp.refresh.token.enabled = true
confluent.oidc.idp.groups.claim.name = groups
confluent.oidc.idp.sub.claim.name = email
confluent.metadata.server.sso.mode = oidc
confluent.metadata.server.user.store = LDAP_WITH_OAUTH
confluent.metadata.server.oauthbearer.jwks.endpoint.url = https://login.microsoftonline.com/{{ azure_tenant_id }}/discovery/v2.0/keys
confluent.metadata.server.oauthbearer.expected.issuer = https://login.microsoftonline.com/{{ azure_tenant_id }}/v2.0
confluent.metadata.server.oauthbearer.expected.audience = {{ server_client_id }}
confluent.metadata.server.oauthbearer.sub.claim.name = sub
confluent.metadata.server.oauthbearer.groups.claim.name = groups

# ---- MDS Service ----
confluent.metadata.server.listeners = https://0.0.0.0:{{ kafka_mds_port }}
confluent.metadata.server.advertised.listeners = https://{{ ansible_fqdn }}:{{ kafka_mds_port }}
confluent.metadata.server.ssl.truststore.location = {{ ssl_truststore_location }}
confluent.metadata.server.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.metadata.server.ssl.truststore.password}
confluent.metadata.server.ssl.keystore.location = {{ ssl_keystore_location }}
confluent.metadata.server.ssl.keystore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.metadata.server.ssl.keystore.password}
confluent.metadata.server.ssl.key.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.metadata.server.ssl.key.password}
confluent.metadata.server.authentication.method = BEARER
confluent.metadata.server.token.auth.enable = true
confluent.metadata.server.token.max.lifetime.ms = {{ mds_token_max_lifetime_ms }}
confluent.metadata.server.token.signature.algorithm = {{ mds_token_signature_algorithm }}
confluent.metadata.server.token.key.path = {{ mds_keypair_path }}
confluent.metadata.server.public.key.path = {{ mds_public_key_path }}

# ---- AD Listener (LDAP-backed PLAIN) ----
listener.name.ad.ssl.truststore.location = {{ ssl_truststore_location }}
listener.name.ad.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.ad.ssl.truststore.password}
listener.name.ad.ssl.keystore.location = {{ ssl_keystore_location }}
listener.name.ad.ssl.keystore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.ad.ssl.keystore.password}
listener.name.ad.ssl.key.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/listener.name.ad.ssl.key.password}
listener.name.ad.sasl.enabled.mechanisms = PLAIN
listener.name.ad.plain.sasl.jaas.config = org.apache.kafka.common.security.plain.PlainLoginModule required;
listener.name.ad.plain.sasl.server.callback.handler.class = io.confluent.security.auth.provider.ldap.LdapAuthenticateCallbackHandler

# ---- RBAC Authorizer ----
authorizer.class.name = io.confluent.kafka.security.authorizer.ConfluentServerAuthorizer
confluent.authorizer.access.rule.providers = ZK_ACL,CONFLUENT

# ---- License ----
confluent.license = {{ confluent_license | default('') }}

# ---- Audit Logging ----
confluent.security.event.logger.enable = {{ audit_log_enable }}
confluent.security.event.logger.exporter.kafka.topic.create = {{ kafka_security_event_logger_topic_create }}
confluent.security.event.logger.exporter.kafka.bootstrap.servers = {{ bstring | default(audit_log_bootstrap_servers) }}
{% set router_config = '{"destinations":{"topics":{"' + audit_topic_denied + '":{"retention_ms":' + audit_topic_retention_ms | string + '},"' + audit_topic_allowed + '":{"retention_ms":' + audit_topic_retention_ms | string + '}}},"default_topics":{"allowed":"' + audit_topic_allowed + '","denied":"' + audit_topic_denied + '"},"excluded_principals":["' + audit_excluded_principals + '"]}' %}
confluent.security.event.router.config = {{ router_config }}
confluent.security.event.logger.exporter.kafka.sasl.mechanism = SCRAM-SHA-256
confluent.security.event.logger.exporter.kafka.security.protocol = SASL_SSL
confluent.security.event.logger.exporter.kafka.ssl.truststore.location = {{ ssl_truststore_location }}
confluent.security.event.logger.exporter.kafka.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.security.event.logger.exporter.kafka.ssl.truststore.password}
confluent.security.event.logger.exporter.kafka.sasl.jaas.config = org.apache.kafka.common.security.scram.ScramLoginModule required username='admin' password=${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/confluent.security.event.logger.exporter.kafka.sasl.jaas.config/org.apache.kafka.common.security.scram.ScramLoginModule/password};

# ---- Confluent Support ----
confluent.support.metrics.enable = {{ confluent_support_metrics_enable }}
confluent.support.customer.id = {{ confluent_support_customer_id }}

# ---- Super Users ----
super.users = {{ super_users }}

# ---- LDAP Configuration ----
ldap.java.naming.factory.initial = com.sun.jndi.ldap.LdapCtxFactory
ldap.java.naming.provider.url = {{ ldap_provider_url }}
ldap.refresh.interval.ms = {{ ldap_refresh_interval_ms }}
ldap.java.naming.security.principal = {{ ldap_principal }}
ldap.java.naming.security.credentials = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/ldap.java.naming.security.credentials}
ldap.java.naming.security.authentication = SIMPLE
ldap.java.naming.referral = {{ ldap_referral }}
ldap.group.search.base = {{ ldap_group_search_base }}
ldap.group.object.class = {{ ldap_group_object_class }}
ldap.group.name.attribute = {{ ldap_group_name_attribute }}
ldap.group.member.attribute = {{ ldap_group_member_attribute }}
ldap.group.search.scope = {{ ldap_group_search_scope }}
ldap.search.mode = {{ ldap_search_mode }}
ldap.user.search.base = {{ ldap_user_search_base }}
ldap.user.search.filter = {{ ldap_user_search_filter }}
ldap.user.name.attribute = {{ ldap_user_name_attribute }}
ldap.user.memberof.attribute = {{ ldap_user_memberof_attribute }}
ldap.user.object.class = {{ ldap_user_object_class }}
ldap.user.search.scope = {{ ldap_user_search_scope }}
ldap.search.page.size = {{ ldap_search_page_size }}
ldap.group.member.attribute.pattern = {{ ldap_group_member_attribute_pattern }}
ldap.user.member.attribute.pattern = {{ ldap_user_member_attribute_pattern }}
ldap.java.naming.security.protocol = SSL
ldap.ssl.truststore.location = {{ ssl_truststore_location }}
ldap.ssl.truststore.password = ${securepass:{{ broker_secrets_dir }}/local-secrets.properties:server.properties/ldap.ssl.truststore.password}

# ---- Secure Pass Config Provider ----
config.providers = securepass
config.providers.securepass.class = {{ config_provider_class }}
config.providers.securepass.param.master.encryption.key = {{ confluent_security_master_key }}
