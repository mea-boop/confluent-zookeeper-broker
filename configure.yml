---
# ==============================================================================
# Configure Kafka Broker
# Mirrors: roles/zookeeper/tasks/configure.yml
# ==============================================================================

- name: Resolve broker_id for this host from broker_id_map
  ansible.builtin.set_fact:
    broker_id: "{{ broker_id_map[inventory_hostname] }}"
    cacheable: true

- name: Display broker identity
  ansible.builtin.debug:
    msg: "Broker ID {{ broker_id }} assigned to {{ ansible_fqdn }}"

- name: Verify all broker nodes have FQDN defined
  ansible.builtin.assert:
    that:
      - hostvars[item]['ansible_fqdn'] is defined
      - hostvars[item]['ansible_fqdn'] != ''
    fail_msg: "FQDN not found for {{ item }}"
    success_msg: "FQDN verified: {{ hostvars[item]['ansible_fqdn'] }}"
  loop: "{{ groups['broker_nodes'] }}"
  run_once: true

- name: Verify all broker nodes have broker_id_map entries
  ansible.builtin.assert:
    that:
      - broker_id_map[item] is defined
    fail_msg: "broker_id_map entry missing for host: {{ item }}"
    success_msg: "broker_id_map[{{ item }}] = {{ broker_id_map[item] }}"
  loop: "{{ groups['broker_nodes'] }}"
  run_once: true

- name: Display cluster listener configuration
  ansible.builtin.debug:
    msg: |
      Broker Cluster Listener Configuration:
      {% for host in groups['broker_nodes'] %}
      broker_id={{ broker_id_map[host] }}  SASL_SSL={{ hostvars[host]['ansible_fqdn'] }}:{{ kafka_sasl_ssl_port }}  TOKEN={{ hostvars[host]['ansible_fqdn'] }}:{{ kafka_token_port }}  AD={{ hostvars[host]['ansible_fqdn'] }}:{{ kafka_ad_port }}
      {% endfor %}
  run_once: true

- name: Create broker config directory
  ansible.builtin.file:
    path: "{{ broker_config_dir }}"
    state: directory
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"

- name: Deploy server.properties (SecurePass placeholders - no plaintext secrets)
  ansible.builtin.template:
    src: server.properties.j2
    dest: "{{ broker_config_dir }}/server.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
    backup: true
  notify: restart confluent-kafka

- name: Deploy log4j.properties
  ansible.builtin.template:
    src: log4j.properties.j2
    dest: "{{ broker_config_dir }}/log4j.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0644"
  notify: restart confluent-kafka

- name: Deploy broker-env.sh (JVM, JMX, Prometheus environment)
  ansible.builtin.template:
    src: broker-env.sh.j2
    dest: "{{ broker_install_dir }}/bin/broker-env.sh"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"
  notify: restart confluent-kafka
