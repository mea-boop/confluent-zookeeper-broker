---
# ==============================================================================
# Configure Kafka Broker
#
# server.properties strategy: FULL TEMPLATE REPLACE
#   - Template is the single source of truth for structure, headings, and order
#   - All section headings (# ---- Listeners ----, etc.) are preserved exactly
#   - Secrets use ${securepass:...} placeholders — no plaintext in the file
#   - Existing file is backed up to server.properties.bak before each deploy
#   - master.encryption.key is the only sensitive value rendered in plain text;
#     no_log: true on the template task prevents it appearing in AAP job logs
#
# broker_id strategy: derived from the host's 0-based index in the
#   broker_nodes AAP inventory group + broker_id_base offset.
#   No broker_id_map needed — adding a new broker in AAP auto-assigns its ID.
# ==============================================================================

# ------------------------------------------------------------------
# Load variables explicitly — guarantees they are available even if
# group_vars auto-load did not fire (AAP group name mismatch etc.)
# ------------------------------------------------------------------
- name: "CONFIGURE | Load group_vars/all.yml"
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all.yml"

- name: "CONFIGURE | Load and decrypt vault_secrets.yml"
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/vault_secrets.yml"
  no_log: true

# ------------------------------------------------------------------
# Map vault_ variables to plain names used by templates
# ------------------------------------------------------------------
- name: "CONFIGURE | Map vault_ variables to plain names"
  ansible.builtin.set_fact:
    kafka_admin_password:          "{{ vault_kafka_admin_password }}"
    ldap_bind_password:            "{{ vault_ldap_bind_password }}"
    ssl_truststore_password:       "{{ vault_ssl_truststore_password }}"
    ssl_keystore_password:         "{{ vault_ssl_keystore_password }}"
    ssl_key_password:              "{{ vault_ssl_key_password }}"
    confluent_security_master_key: "{{ vault_confluent_security_master_key }}"
    jfrog_user:                    "{{ vault_jfrog_user }}"
    jfrog_password:                "{{ vault_jfrog_password }}"
    oidc_client_secret:            "{{ vault_oidc_client_secret }}"
  no_log: true

# ------------------------------------------------------------------
# Resolve broker_id from this host's position in broker_nodes group.
# Index is 0-based; broker_id_base (default 1) sets the starting ID.
# Example: broker_id_base=1 → broker IDs 1, 2, 3 ...
#          broker_id_base=35 → broker IDs 35, 36, 37 ...
# ------------------------------------------------------------------
- name: "CONFIGURE | Resolve broker_id from broker_nodes group position"
  ansible.builtin.set_fact:
    broker_id: >-
      {{
        broker_id_base | int
        + groups['broker_nodes'].index(inventory_hostname)
      }}
    cacheable: true

- name: "CONFIGURE | Display broker identity"
  ansible.builtin.debug:
    msg: "Broker ID {{ broker_id }} → {{ ansible_fqdn }} (index {{ groups['broker_nodes'].index(inventory_hostname) }} in broker_nodes)"

# ------------------------------------------------------------------
# Pre-flight checks — validate both inventory groups are populated
# ------------------------------------------------------------------
- name: "CONFIGURE | Assert broker_nodes group is defined and non-empty"
  ansible.builtin.assert:
    that:
      - groups['broker_nodes'] is defined
      - groups['broker_nodes'] | length > 0
    fail_msg: >-
      AAP inventory group 'broker_nodes' is missing or empty.
      Create the group and add all Kafka broker hosts to it.
  run_once: true

- name: "CONFIGURE | Assert zookeeper_nodes group is defined and non-empty"
  ansible.builtin.assert:
    that:
      - groups['zookeeper_nodes'] is defined
      - groups['zookeeper_nodes'] | length > 0
    fail_msg: >-
      AAP inventory group 'zookeeper_nodes' is missing or empty.
      Create the group and add all ZooKeeper hosts to it.
  run_once: true

- name: "CONFIGURE | Verify ansible_fqdn is set for all broker_nodes"
  ansible.builtin.assert:
    that:
      - hostvars[item]['ansible_fqdn'] is defined
      - hostvars[item]['ansible_fqdn'] != ''
    fail_msg: "ansible_fqdn not resolved for broker node: {{ item }}"
  loop: "{{ groups['broker_nodes'] }}"
  run_once: true

- name: "CONFIGURE | Verify ansible_fqdn is set for all zookeeper_nodes"
  ansible.builtin.assert:
    that:
      - hostvars[item]['ansible_fqdn'] is defined
      - hostvars[item]['ansible_fqdn'] != ''
    fail_msg: "ansible_fqdn not resolved for zookeeper node: {{ item }}"
  loop: "{{ groups['zookeeper_nodes'] }}"
  run_once: true

# ------------------------------------------------------------------
# Ensure config directory exists
# ------------------------------------------------------------------
- name: "CONFIGURE | Create broker config directory"
  ansible.builtin.file:
    path: "{{ broker_config_dir }}"
    state: directory
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"

# ==================================================================
# DEPLOY server.properties directly from Jinja2 template.
#
# The template is the single source of truth — all section headings,
# comments, and property ordering are preserved exactly as authored.
# Secrets use ${securepass:...} placeholders so no plaintext values
# are written into the file. no_log covers master.encryption.key
# which is the only sensitive value rendered in plain text.
# ==================================================================

- name: "CONFIGURE | Back up existing server.properties before deploy"
  ansible.builtin.copy:
    src: "{{ broker_config_dir }}/server.properties"
    dest: "{{ broker_config_dir }}/server.properties.bak"
    remote_src: true
    force: true
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
  failed_when: false   # skip silently if no existing file

- name: "CONFIGURE | Deploy server.properties from template"
  ansible.builtin.template:
    src: server.properties.j2
    dest: "{{ broker_config_dir }}/server.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
    backup: false
  no_log: true
  # no_log: rendered file contains config.providers.securepass.param.master.encryption.key
  # in plaintext. Temporarily set no_log: false to debug Jinja2 template errors,
  # then restore to true before committing.
  notify: restart confluent-kafka

# ------------------------------------------------------------------
# Deploy remaining config files (full replace — no secrets in these)
# ------------------------------------------------------------------
- name: "CONFIGURE | Deploy log4j.properties"
  ansible.builtin.template:
    src: log4j.properties.j2
    dest: "{{ broker_config_dir }}/log4j.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0644"
  notify: restart confluent-kafka

- name: "CONFIGURE | Deploy broker-env.sh"
  ansible.builtin.template:
    src: broker-env.sh.j2
    dest: "{{ broker_install_dir }}/bin/broker-env.sh"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"
  notify: restart confluent-kafka
