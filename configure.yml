---
# ==============================================================================
# Configure Kafka Broker
#
# server.properties strategy: UPSERT (append new, update existing)
#   - Template renders to /tmp staging file (uses ${securepass:...} placeholders)
#   - Each key=value line is upserted into the live server.properties
#   - Live file is never truncated - existing/manual properties preserved
#   - New properties added to server.properties.j2 are appended automatically
#
# broker_id strategy: derived from the host's 0-based index in the
#   broker_nodes AAP inventory group + broker_id_base offset (default 1).
#   No broker_id_map needed — adding a new broker in AAP auto-assigns its ID.
# ==============================================================================

# ------------------------------------------------------------------
# Load variables explicitly — guarantees they are available even if
# group_vars auto-load did not fire (AAP group name mismatch etc.)
# ------------------------------------------------------------------
- name: "CONFIGURE | Load group_vars/all.yml"
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/all.yml"

- name: "CONFIGURE | Load and decrypt vault_secrets.yml"
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../group_vars/vault_secrets.yml"
  no_log: true

# ------------------------------------------------------------------
# Map vault_ variables to plain names used by templates
# ------------------------------------------------------------------
- name: "CONFIGURE | Map vault_ variables to plain names"
  ansible.builtin.set_fact:
    kafka_admin_password:          "{{ vault_kafka_admin_password }}"
    ldap_bind_password:            "{{ vault_ldap_bind_password }}"
    ssl_truststore_password:       "{{ vault_ssl_truststore_password }}"
    ssl_keystore_password:         "{{ vault_ssl_keystore_password }}"
    ssl_key_password:              "{{ vault_ssl_key_password }}"
    confluent_security_master_key: "{{ vault_confluent_security_master_key }}"
    jfrog_user:                    "{{ vault_jfrog_user }}"
    jfrog_password:                "{{ vault_jfrog_password }}"
    oidc_client_secret:            "{{ vault_oidc_client_secret }}"
  no_log: true

# ------------------------------------------------------------------
# Resolve broker_id from this host's position in broker_nodes group.
# Index is 0-based; broker_id_base (default 1) sets the starting ID.
# Example: broker_id_base=1 → broker IDs 1, 2, 3 ...
#          broker_id_base=35 → broker IDs 35, 36, 37 ...
# ------------------------------------------------------------------
- name: "CONFIGURE | Resolve broker_id from broker_nodes group position"
  ansible.builtin.set_fact:
    broker_id: >-
      {{
        broker_id_base | int
        + groups['broker_nodes'].index(inventory_hostname)
      }}
    cacheable: true

- name: "CONFIGURE | Display broker identity"
  ansible.builtin.debug:
    msg: "Broker ID {{ broker_id }} → {{ ansible_fqdn }} (index {{ groups['broker_nodes'].index(inventory_hostname) }} in broker_nodes)"

# ------------------------------------------------------------------
# Pre-flight checks — validate both inventory groups are populated
# ------------------------------------------------------------------
- name: "CONFIGURE | Assert broker_nodes group is defined and non-empty"
  ansible.builtin.assert:
    that:
      - groups['broker_nodes'] is defined
      - groups['broker_nodes'] | length > 0
    fail_msg: >-
      AAP inventory group 'broker_nodes' is missing or empty.
      Create the group and add all Kafka broker hosts to it.
  run_once: true

- name: "CONFIGURE | Assert zookeeper_nodes group is defined and non-empty"
  ansible.builtin.assert:
    that:
      - groups['zookeeper_nodes'] is defined
      - groups['zookeeper_nodes'] | length > 0
    fail_msg: >-
      AAP inventory group 'zookeeper_nodes' is missing or empty.
      Create the group and add all ZooKeeper hosts to it.
  run_once: true

- name: "CONFIGURE | Verify ansible_fqdn is set for all broker_nodes"
  ansible.builtin.assert:
    that:
      - hostvars[item]['ansible_fqdn'] is defined
      - hostvars[item]['ansible_fqdn'] != ''
    fail_msg: "ansible_fqdn not resolved for broker node: {{ item }}"
  loop: "{{ groups['broker_nodes'] }}"
  run_once: true

- name: "CONFIGURE | Verify ansible_fqdn is set for all zookeeper_nodes"
  ansible.builtin.assert:
    that:
      - hostvars[item]['ansible_fqdn'] is defined
      - hostvars[item]['ansible_fqdn'] != ''
    fail_msg: "ansible_fqdn not resolved for zookeeper node: {{ item }}"
  loop: "{{ groups['zookeeper_nodes'] }}"
  run_once: true

# ------------------------------------------------------------------
# Ensure config directory exists
# ------------------------------------------------------------------
- name: "CONFIGURE | Create broker config directory"
  ansible.builtin.file:
    path: "{{ broker_config_dir }}"
    state: directory
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"

# ==================================================================
# UPSERT STRATEGY FOR server.properties
#
# Step 1: Render template → /tmp/server.properties.staged
#         Staging file uses ${securepass:...} placeholders — no
#         plaintext passwords. no_log covers master.encryption.key.
#
# Step 2: Slurp staged file, filter to key=value lines only
#
# Step 3: Extract key as everything before the FIRST '=' only
#         (handles values that contain '=' e.g. jaas.config lines)
#
# Step 4: lineinfile upserts each key into the live file:
#         - key exists → value updated in-place
#         - key missing → line appended at end of file
#
# Step 5: Cleanup staging file
# ==================================================================

- name: "CONFIGURE | Render server.properties to staging file"
  ansible.builtin.template:
    src: server.properties.j2
    dest: /tmp/server.properties.staged
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
  no_log: true
  # no_log: staging file contains config.providers.securepass.param.master.encryption.key
  # in plaintext. Temporarily set no_log: false to debug Jinja2 template errors,
  # then restore to true before committing.

- name: "CONFIGURE | Ensure live server.properties exists"
  ansible.builtin.file:
    path: "{{ broker_config_dir }}/server.properties"
    state: touch
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
    modification_time: preserve
    access_time: preserve

- name: "CONFIGURE | Slurp staged server.properties"
  ansible.builtin.slurp:
    src: /tmp/server.properties.staged
  register: staged_raw

- name: "CONFIGURE | Parse key=value lines from staged file"
  ansible.builtin.set_fact:
    staged_props: >-
      {{
        (staged_raw.content | b64decode).splitlines()
        | select('match', '^[A-Za-z][A-Za-z0-9._-]+=')
        | list
      }}

- name: "CONFIGURE | Extract property keys from staged lines"
  ansible.builtin.set_fact:
    staged_kv: >-
      {{
        staged_props | map('regex_replace', '^([^=]+)=.*$', '\1') | list
      }}

- name: "CONFIGURE | Upsert each property into live server.properties"
  ansible.builtin.lineinfile:
    path: "{{ broker_config_dir }}/server.properties"
    regexp: "^{{ staged_kv[idx] | regex_escape }}="
    line: "{{ item }}"
    state: present
    create: true
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0640"
    backup: false
  loop: "{{ staged_props }}"
  loop_control:
    index_var: idx
    label: "{{ staged_kv[idx] }}"
  notify: restart confluent-kafka
  no_log: true
  # no_log: loop iterates the master.encryption.key line in plaintext

- name: "CONFIGURE | Remove staging file"
  ansible.builtin.file:
    path: /tmp/server.properties.staged
    state: absent

# ------------------------------------------------------------------
# Deploy remaining config files (full replace — no secrets in these)
# ------------------------------------------------------------------
- name: "CONFIGURE | Deploy log4j.properties"
  ansible.builtin.template:
    src: log4j.properties.j2
    dest: "{{ broker_config_dir }}/log4j.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0644"
  notify: restart confluent-kafka

- name: "CONFIGURE | Deploy broker-env.sh"
  ansible.builtin.template:
    src: broker-env.sh.j2
    dest: "{{ broker_install_dir }}/bin/broker-env.sh"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: "0755"
  notify: restart confluent-kafka
