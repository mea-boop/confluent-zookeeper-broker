---
# Extract and install Confluent from local tar file

- name: Check if Confluent package exists
  stat:
    path: "{{ confluent_package_path }}"
  register: confluent_tar

- name: Fail if Confluent package not found
  fail:
    msg: "Confluent package not found at {{ confluent_package_path }}"
  when: not confluent_tar.stat.exists

- name: Extract Confluent package
  unarchive:
    src: "{{ confluent_package_path }}"
    dest: /tmp/
    remote_src: yes
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
  register: extract_result

- name: Find extracted directory
  find:
    paths: /tmp
    patterns: "confluent*"
    file_type: directory
  register: confluent_dirs

- name: Set extracted directory fact
  set_fact:
    extracted_dir: "{{ confluent_dirs.files[0].path }}"
  when: confluent_dirs.matched > 0

- name: Create install directory
  file:
    path: "{{ broker_install_dir }}"
    state: directory
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: '0755'

- name: Copy Confluent to install directory
  shell: |
    cp -r {{ extracted_dir }}/* {{ broker_install_dir }}/
    chown -R {{ broker_user }}:{{ broker_group }} {{ broker_install_dir }}
  args:
    creates: "{{ broker_install_dir }}/bin/kafka-server-start"

- name: Verify Kafka binaries
  stat:
    path: "{{ broker_install_dir }}/bin/kafka-server-start"
  register: kafka_binary

- name: Fail if Kafka binary not found
  fail:
    msg: "Kafka binary not found in {{ broker_install_dir }}/bin"
  when: not kafka_binary.stat.exists
