---
# Append encrypted secrets from broker-secret.yml to server.properties

- name: Get list of secret variables
  set_fact:
    secret_vars: "{{ vars | dict2items | selectattr('key', 'in', ['ssl_keystore_location', 'ssl_keystore_password', 'ssl_key_password', 'ssl_truststore_location', 'ssl_truststore_password', 'sasl_mechanism', 'sasl_enabled_mechanisms', 'security_inter_broker_protocol', 'listener_security_protocol_map']) | list }}"

- name: Display secrets being appended (masked)
  debug:
    msg: "Appending {{ secret_vars | length }} encrypted configuration parameters to server.properties"

- name: Create backup of server.properties
  copy:
    src: "{{ broker_config_dir }}/server.properties"
    dest: "{{ broker_config_dir }}/server.properties.backup"
    remote_src: yes
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: '0644'

- name: Append encrypted secrets to server.properties
  blockinfile:
    path: "{{ broker_config_dir }}/server.properties"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - ENCRYPTED SECRETS"
    block: |
      # Security Configuration - Loaded from encrypted broker-secret.yml
      # Last updated: {{ ansible_date_time.iso8601 }}
      
      {% if ssl_keystore_location is defined %}
      ssl.keystore.location={{ ssl_keystore_location }}
      {% endif %}
      {% if ssl_keystore_password is defined %}
      ssl.keystore.password={{ ssl_keystore_password }}
      {% endif %}
      {% if ssl_key_password is defined %}
      ssl.key.password={{ ssl_key_password }}
      {% endif %}
      {% if ssl_truststore_location is defined %}
      ssl.truststore.location={{ ssl_truststore_location }}
      {% endif %}
      {% if ssl_truststore_password is defined %}
      ssl.truststore.password={{ ssl_truststore_password }}
      {% endif %}
      {% if sasl_mechanism is defined %}
      sasl.mechanism.inter.broker.protocol={{ sasl_mechanism }}
      {% endif %}
      {% if sasl_enabled_mechanisms is defined %}
      sasl.enabled.mechanisms={{ sasl_enabled_mechanisms }}
      {% endif %}
      {% if security_inter_broker_protocol is defined %}
      security.inter.broker.protocol={{ security_inter_broker_protocol }}
      {% endif %}
      {% if listener_security_protocol_map is defined %}
      listener.security.protocol.map={{ listener_security_protocol_map }}
      {% endif %}
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: '0600'
  no_log: true

- name: Set secure permissions on server.properties
  file:
    path: "{{ broker_config_dir }}/server.properties"
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
    mode: '0600'

- name: Display secret append status
  debug:
    msg: "Encrypted secrets successfully appended to server.properties with secure permissions (0600)"
