---
# ==============================================================================
# Confluent Kafka Broker Variables  -  group_vars/all.yml
# Environment  : prd-eastus2-az3
# Loaded for   : ALL hosts (group_vars/all.yml is always loaded by Ansible
#                regardless of what the AAP inventory group is named)
# Also kept as : group_vars/broker_nodes.yml  for when group name matches exactly
# ==============================================================================
#
# IMPORTANT - YAML VARIABLE NAMING RULES:
#   CORRECT:   confluent_license: "value"      (underscore, colon separator)
#   WRONG:     confluent.license = "value"     (dot = invalid key, = invalid separator)
#   WRONG:     confluent.license: "value"      (dot makes YAML treat as nested dict)
#
#   ALL Ansible variable names must use underscores only, never dots.
#   Dots are valid INSIDE string values but not in key names.
# ==============================================================================

# ------------------------------------------------------------------------------
# Confluent Version & Package
# ------------------------------------------------------------------------------
confluent_version: "7.7.3"
confluent_package_version: "7.7.3"
confluent_package_path: "/app/kafka/log/confluent-7.7.3.tar.gz"
confluent_extract_dir: "/app/kafka/data/confluent"

# Confluent License - plain variable, not a secret, safe in Git
# This is a JWT token that activates Confluent Enterprise features.
confluent_license: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1YXQiOjE3NTA3MDc2NTgsInN1YiI6ImNvbnRyb2wtY2VudGVyIiwibmI0IjoiMTc1MDcwNzUzOCIsIm1vbml0b3JpbmciOnRydWUsImxpY2Vuc2VUeXBlIjoiRW50ZXJwcmlzZSIsImlzcyI6IkNvbmZsdWVudCIsImlhdCI6MTc0NzM3ODgwMCwiZXhwIjoxODQ0NjY1MjAwLCJhdWQiOiIwMDZVejAwMDAwUUltN0pJQVQiLCJhZGRvbiI6bnVsbH0=.igU5IKi5_va7bmfBHYTpUAOU3nJ4F-CisqMdgC8NVyF_9qZ2c1vafhZK9G5my0re0CXF8ha2-J8Wm3R4syNDbMfo8BHr_DS1xu-3OYSWnOoFphXxyLxH6ec2-2pypPpIj9j1G9MdaZUlXc3DzkrLxpu8jFUKHtq13NoCiPFSAMGGY4a6lcstvHy9Ofp-JmVBuL_8EZilLTwiaXZga930APL7Sgx3tXZjzK8Zjgntm-l5Doa4xwWjJ2VIWeoFEVQM8yUlwfV_L7W6Oxfr26hT4fvBfc5JSfx64JOYk0x_6NNaSrOLrXdxZtfnSD903_C9f_k8K_CXbotzzeZGs2WExQ"

# ------------------------------------------------------------------------------
# User and Group
# ------------------------------------------------------------------------------
broker_user: "confluent"
broker_group: "confluent"

# ------------------------------------------------------------------------------
# Directories
# ------------------------------------------------------------------------------
broker_install_dir: "/app/kafka/data/confluent"
broker_data_dir: "/app/kafka/data"
broker_log_dir: "/app/kafka/log"
broker_config_dir: "/app/kafka/data/confluent/etc/kafka"
broker_secrets_dir: "/opt/secrets"
ssl_dir: "/opt/ssl"

# ------------------------------------------------------------------------------
# Broker ID Base
# broker_id is assigned at runtime as: broker_id_base + index_in_broker_nodes_group
# The first host in the broker_nodes AAP group gets broker_id_base,
# the second gets broker_id_base + 1, and so on.
# Adjust broker_id_base so IDs do not collide with other clusters.
# ------------------------------------------------------------------------------
broker_id_base: 35

# ------------------------------------------------------------------------------
# Broker Rack / AZ
# ------------------------------------------------------------------------------
broker_rack: "eastus2-2"

# ------------------------------------------------------------------------------
# Cluster Connect Strings — built at runtime from AAP inventory groups
#
# bstring               : built in install_confluent.yml from groups['broker_nodes']
# zookeeper_connect_dynamic : built in install_confluent.yml from groups['zookeeper_nodes']
#
# The static zookeeper_connect below is used ONLY as a fallback if the dynamic
# fact was not set (e.g. running configure.yml in isolation). In normal AAP
# deployments the dynamic value always takes precedence.
# ------------------------------------------------------------------------------
zookeeper_connect: "DYNAMIC_FROM_INVENTORY_SEE_install_confluent.yml"
zookeeper_connection_timeout_ms: 18000

# ------------------------------------------------------------------------------
# Listener Ports
# ------------------------------------------------------------------------------
kafka_sasl_ssl_port: 9093
kafka_token_port: 9092
kafka_ad_port: 9094
kafka_mds_port: 8090
kafka_jmx_port: 9000
kafka_leader_election_port: 9093    # Inter-broker / leader election

# ------------------------------------------------------------------------------
# Listeners (built from inventory_hostname at runtime)
# ------------------------------------------------------------------------------
kafka_listener_security_protocol_map: "SASL_SSL:SASL_SSL,TOKEN:SASL_SSL,AD:SASL_SSL"

# ------------------------------------------------------------------------------
# SSL / TLS Paths
# ------------------------------------------------------------------------------
ssl_truststore_location: "{{ ssl_dir }}/truststore.jks"
ssl_keystore_location: "{{ ssl_dir }}/_.prd.eeh.humana.com.pfx"
mds_keypair_path: "{{ ssl_dir }}/mdskeypair.pem"
mds_public_key_path: "{{ ssl_dir }}/mdspublic.pem"

# ------------------------------------------------------------------------------
# Security
# ------------------------------------------------------------------------------
sasl_enabled_mechanisms: "SCRAM-SHA-256"
sasl_mechanism_inter_broker_protocol: "SCRAM-SHA-256"
security_inter_broker_protocol: "SASL_SSL"
inter_broker_protocol_version: "3.5"

# ------------------------------------------------------------------------------
# Broker Tuning
# ------------------------------------------------------------------------------
num_network_threads: 8
num_io_threads: 16
socket_send_buffer_bytes: 102400
socket_receive_buffer_bytes: 102400
socket_request_max_bytes: 104857600
num_partitions: 3
num_recovery_threads_per_data_dir: 2
log_retention_hours: 168
log_segment_bytes: 1073741824
log_retention_check_interval_ms: 300000
group_initial_rebalance_delay_ms: 3000
offset_topic_replication_factor: 3
transaction_state_log_replication_factor: 3
transaction_state_log_min_isr: 2
auto_create_topics_enable: "false"
min_insync_replicas: 2
replica_socket_receive_buffer_bytes: 5242880
num_replica_fetchers: 2
confluent_metadata_default_api_timeout_ms: 600000

# ------------------------------------------------------------------------------
# Metrics Reporter
# ------------------------------------------------------------------------------
metrics_reporter_topic_retention_ms: 604800000
metrics_reporter_bootstrap_servers: "{{ broker_bootstrap_fqdn }}:{{ kafka_sasl_ssl_port }}"

# ------------------------------------------------------------------------------
# MDS (Metadata Service)
# ------------------------------------------------------------------------------
mds_token_max_lifetime_ms: 3600000
mds_token_signature_algorithm: "RS256"

# ------------------------------------------------------------------------------
# RBAC / Authorizer
# ------------------------------------------------------------------------------
super_users: "User:admin;User:EEH_C3E_AZ_KFKA_PRD"

# ------------------------------------------------------------------------------
# Audit Logging
# ------------------------------------------------------------------------------
audit_log_enable: true
audit_log_bootstrap_servers: "{{ broker_bootstrap_fqdn }}:{{ kafka_sasl_ssl_port }}"
audit_topic_allowed: "confluent-audit-log-events-allowed"
audit_topic_denied: "confluent-audit-log-events-denied"
audit_topic_retention_ms: 604800000
audit_excluded_principals: "User:admin"
kafka_security_event_logger_topic_create: "false"

# ------------------------------------------------------------------------------
# LDAP
# ------------------------------------------------------------------------------
ldap_provider_url: "ldaps://azurecloud-ldap.humana.com:3269"
ldap_refresh_interval_ms: 120000
ldap_principal: "CN=EEH_C3E_AZ_KFKA_PRD,OU=ServiceAccounts,OU=Azure,DC=humad,DC=com"
ldap_referral: "follow"
ldap_group_search_base: "DC=humad,DC=com"
ldap_group_object_class: "group"
ldap_group_name_attribute: "cn"
ldap_group_member_attribute: "member"
ldap_group_search_scope: 2
ldap_search_mode: "USERS"
ldap_user_search_base: "DC=humad,DC=com"
ldap_user_search_filter: "(|(memberOf=CN=G_Azure_C3_EEH_filtergroup_prd,OU=Groups,OU=Azure,DC=humad,DC=com))"
ldap_user_name_attribute: "sAMAccountName"
ldap_user_memberof_attribute: "memberOf"
ldap_user_object_class: "user"
ldap_user_search_scope: 2
ldap_search_page_size: 1000
ldap_group_member_attribute_pattern: "CN=(.*?),.*"
ldap_user_member_attribute_pattern: "CN=(.*?),.*"

# ------------------------------------------------------------------------------
# Prometheus JMX Exporter
# ------------------------------------------------------------------------------
prometheus_jmx_exporter_enabled: true
prometheus_jmx_exporter_version: "0.20.0"
prometheus_jmx_exporter_port: 8085
prometheus_jmx_exporter_jar: "/opt/prometheus/jmx_prometheus_javaagent-{{ prometheus_jmx_exporter_version }}.jar"
prometheus_jmx_config: "/opt/prometheus/prometheus-config/jmx-kafka-prometheus.yml"

# Java Agent string used in systemd Environment and zookeeper-env equivalent
java_agent_string: "-javaagent:{{ prometheus_jmx_exporter_jar }}={{ prometheus_jmx_exporter_port }}:{{ prometheus_jmx_config }}"

# ------------------------------------------------------------------------------
# JVM Settings
# ------------------------------------------------------------------------------
broker_heap_opts: "-Xmx6g"
broker_jvm_performance_opts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+DisableExplicitGC"

# ------------------------------------------------------------------------------
# Config Provider
# ------------------------------------------------------------------------------
config_provider_class: "io.confluent.kafka.security.config.provider.SecurePassConfigProvider"

# ------------------------------------------------------------------------------
# Confluent Support
# ------------------------------------------------------------------------------
confluent_support_metrics_enable: "false"
confluent_support_customer_id: "anonymous"

# ------------------------------------------------------------------------------
# Service
# ------------------------------------------------------------------------------
broker_service_name: "confluent-kafka"

# ------------------------------------------------------------------------------
# Restart Settings
# ------------------------------------------------------------------------------
restart_wait_time: 30
restart_max_retries: 10
restart_retry_delay: 5
broker_restart_timeout: 120

# ------------------------------------------------------------------------------
# Installation Flags
# ------------------------------------------------------------------------------
install_java: false
configure_firewall: false
start_broker: true
enable_broker: true
validate_deployment: true
create_broker_user: true

# ------------------------------------------------------------------------------
# Secret Variable References
# Encrypted values live in group_vars/vault_secrets.yml (vault password: humana#1)
# Ansible auto-loads vault_secrets.yml alongside this file via vars_files in the playbook.
# These mappings expose vault_ variables under the plain names used by templates.
# ------------------------------------------------------------------------------
confluent_security_master_key: "{{ vault_confluent_security_master_key }}"
kafka_admin_password:    "{{ vault_kafka_admin_password }}"
ldap_bind_password:      "{{ vault_ldap_bind_password }}"
ssl_truststore_password: "{{ vault_ssl_truststore_password }}"
ssl_keystore_password:   "{{ vault_ssl_keystore_password }}"
ssl_key_password:        "{{ vault_ssl_key_password }}"

# ------------------------------------------------------------------------------
# JFrog Artifact Repository
# Credentials are vaulted in vault_secrets.yml
# ------------------------------------------------------------------------------
jfrog_base_url: "https://jfrog.example.com/artifactory"
jfrog_repo: "confluent-local"
jfrog_user: "{{ vault_jfrog_user }}"
jfrog_password: "{{ vault_jfrog_password }}"
download_retries: 3
download_delay: 10

# ------------------------------------------------------------------------------
# SSL keystore filename (PFX/JKS file downloaded from JFrog)
# ------------------------------------------------------------------------------
ssl_keystore_filename: "_.prd.eeh.humana.com.pfx"

# ------------------------------------------------------------------------------
# Azure AD / OIDC
# oidc_client_secret is vaulted in vault_secrets.yml
# ------------------------------------------------------------------------------
azure_tenant_id: "CHANGEME-azure-tenant-id"
oidc_client_id: "CHANGEME-oidc-client-id"
server_client_id: "CHANGEME-server-client-id"
oidc_client_secret: "{{ vault_oidc_client_secret }}"

# ------------------------------------------------------------------------------
# /etc/hosts + bootstrap strings — derived at runtime from AAP inventory groups
#
# broker_nodes  : AAP inventory group containing the Kafka broker hosts
# zookeeper_nodes: AAP inventory group containing the ZooKeeper hosts
#
# These variables are computed dynamically in install_confluent.yml using
# groups['broker_nodes'] and groups['zookeeper_nodes'] from the live inventory.
# No IPs or hostnames are hardcoded here.
# ------------------------------------------------------------------------------
