---
# ==============================================================================
# group_vars/all.yml
# Confluent Kafka Broker — Non-secret variables
# Environment: npe-centralus-az3
#
# RULES:
#   - NO secrets in this file — all passwords/credentials live in vault_secrets.yml
#   - configure.yml maps vault_ variables to plain names via set_fact (no_log: true)
#   - Variable names use underscores ONLY (no dots, no hyphens in key names)
# ==============================================================================

# ------------------------------------------------------------------------------
# Confluent Version & Package
# ------------------------------------------------------------------------------
confluent_version:         "7.7.3"
confluent_package_version: "7.7.3"
confluent_package_path:    "/app/kafka/log/confluent-7.7.3.tar.gz"
confluent_extract_dir:     "/app/kafka/data/confluent"

# Confluent License — plain value, not a secret
confluent_license: "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1YXQiOjE3NTA3MDc2NTgsInN1YiI6ImNvbnRyb2wtY2VudGVyIiwibmI0IjoiMTc1MDcwNzUzOCIsIm1vbml0b3JpbmciOnRydWUsImxpY2Vuc2VUeXBlIjoiRW50ZXJwcmlzZSIsImlzcyI6IkNvbmZsdWVudCIsImlhdCI6MTc0NzM3ODgwMCwiZXhwIjoxODQ0NjY1MjAwLCJhdWQiOiIwMDZVejAwMDAwUUltN0pJQVQiLCJhZGRvbiI6bnVsbH0=.igU5IKi5_va7bmfBHYTpUAOU3nJ4F-CisqMdgC8NVyF_9qZ2c1vafhZK9G5my0re0CXF8ha2-J8Wm3R4syNDbMfo8BHr_DS1xu-3OYSWnOoFphXxyLxH6ec2-2pypPpIj9j1G9MdaZUlXc3DzkrLxpu8jFUKHtq13NoCiPFSAMGGY4a6lcstvHy9Ofp-JmVBuL_8EZilLTwiaXZga930APL7Sgx3tXZjzK8Zjgntm-l5Doa4xwWjJ2VIWeoFEVQM8yUlwfV_L7W6Oxfr26hT4fvBfc5JSfx64JOYk0x_6NNaSrOLrXdxZtfnSD903_C9f_k8K_CXbotzzeZGs2WExQ"

# ------------------------------------------------------------------------------
# User and Group
# ------------------------------------------------------------------------------
broker_user:  "confluent"
broker_group: "confluent"

# ------------------------------------------------------------------------------
# Directories
# ------------------------------------------------------------------------------
broker_install_dir: "/app/kafka/data/confluent"
broker_data_dir:    "/app/kafka/data"
broker_log_dir:     "/app/kafka/log"
broker_config_dir:  "/app/kafka/data/confluent/etc/kafka"
broker_secrets_dir: "/opt/secrets"
ssl_dir:            "/opt/ssl"

# ------------------------------------------------------------------------------
# Broker ID
# broker_id is computed at runtime in configure.yml as:
#   broker_id_base + index of this host in the broker_nodes AAP inventory group
# broker_id_map is kept for reference / manual override only.
# ------------------------------------------------------------------------------
broker_id_map:
  dev-broker1-centralus-az3.npe.eeh.humana.com: 231
  dev-broker2-centralus-az3.npe.eeh.humana.com: 232
  dev-broker3-centralus-az3.npe.eeh.humana.com: 233

broker_id_base: 231

# ------------------------------------------------------------------------------
# Broker Rack / AZ  ← REQUIRED by template (broker.rack property)
# ------------------------------------------------------------------------------
broker_rack: "centralus-az3"

# ------------------------------------------------------------------------------
# ZooKeeper Connect
# zookeeper_connect_dynamic is built at runtime from the zookeeper_nodes group.
# The static zookeeper_connect below is a fallback only.
# ------------------------------------------------------------------------------
zookeeper_bootstrap_fqdn:     "dev-zookeeper-bootstrap-centralus-az3.npe.eeh.humana.com"
zookeeper_connect:             "{{ zookeeper_bootstrap_fqdn }}:2181"
zookeeper_connection_timeout_ms: 18000

# ------------------------------------------------------------------------------
# Listener Ports
# ------------------------------------------------------------------------------
kafka_sasl_ssl_port:        9093
kafka_token_port:           9092
kafka_ad_port:              9094
kafka_mds_port:             8090
kafka_jmx_port:             9000
kafka_leader_election_port: 9093

# ------------------------------------------------------------------------------
# SSL / TLS Paths
# ------------------------------------------------------------------------------
ssl_truststore_location: "{{ ssl_dir }}/truststore.jks"
ssl_keystore_location:   "{{ ssl_dir }}/_.npe.cdf.humana.com.pfx"
ssl_keystore_filename:   "_.npe.cdf.humana.com.pfx"
mds_keypair_path:        "{{ ssl_dir }}/mdskeypair.pem"
mds_public_key_path:     "{{ ssl_dir }}/mdspublic.pem"

# ------------------------------------------------------------------------------
# Security
# ------------------------------------------------------------------------------
sasl_enabled_mechanisms:              "SCRAM-SHA-256"
sasl_mechanism_inter_broker_protocol: "SCRAM-SHA-256"
security_inter_broker_protocol:       "SASL_SSL"
inter_broker_protocol_version:        "3.5"

# ------------------------------------------------------------------------------
# Broker Tuning
# ------------------------------------------------------------------------------
num_network_threads:                       8
num_io_threads:                            16
socket_send_buffer_bytes:                  102400
socket_receive_buffer_bytes:               102400
socket_request_max_bytes:                  104857600
num_partitions:                            3
num_recovery_threads_per_data_dir:         2
log_retention_hours:                       168
log_segment_bytes:                         1073741824
log_retention_check_interval_ms:           300000
group_initial_rebalance_delay_ms:          3000
offset_topic_replication_factor:           3
transaction_state_log_replication_factor:  3
transaction_state_log_min_isr:             2
auto_create_topics_enable:                 "false"
min_insync_replicas:                       2
replica_socket_receive_buffer_bytes:       5242880
num_replica_fetchers:                      2
confluent_metadata_default_api_timeout_ms: 600000

# ------------------------------------------------------------------------------
# Bootstrap strings — built at runtime from AAP inventory groups
# Also explicitly rebuilt as set_facts in configure.yml before template runs.
# ------------------------------------------------------------------------------
bstring: >-
  {{
    groups['broker_nodes']
    | map('extract', hostvars, 'ansible_fqdn')
    | map('regex_replace', '$', ':' ~ kafka_sasl_ssl_port | string)
    | join(',')
  }}

zookeeper_connect_dynamic: >-
  {{
    groups['zookeeper_nodes']
    | map('extract', hostvars, 'ansible_fqdn')
    | map('regex_replace', '$', ':2181')
    | join(',')
  }}

# ------------------------------------------------------------------------------
# Metrics Reporter
# ------------------------------------------------------------------------------
metrics_reporter_topic_retention_ms: 604800000
metrics_reporter_bootstrap_servers:  "{{ bstring }}"

# ------------------------------------------------------------------------------
# MDS (Metadata Service)
# ------------------------------------------------------------------------------
mds_token_max_lifetime_ms:     3600000
mds_token_signature_algorithm: "RS256"

# ------------------------------------------------------------------------------
# RBAC / Authorizer
# ------------------------------------------------------------------------------
super_users: "User:admin;User:EEH_C3E_AZ_KFKA_DEV"

# ------------------------------------------------------------------------------
# Audit Logging
# ------------------------------------------------------------------------------
audit_log_enable:                         true
audit_log_bootstrap_servers:              "{{ bstring }}"
audit_topic_allowed:                      "confluent-audit-log-events-allowed"
audit_topic_denied:                       "confluent-audit-log-events-denied"
audit_topic_retention_ms:                 604800000
audit_excluded_principals:                "User:admin"
kafka_security_event_logger_topic_create: "false"

# ------------------------------------------------------------------------------
# LDAP — non-secret values only (bind password is in vault_secrets.yml)
# ------------------------------------------------------------------------------
ldap_provider_url:                  "ldaps://qa-azurecloud-ldap.humana.com:3269"
ldap_refresh_interval_ms:           120000
ldap_principal:                     "CN=EEH_C3E_AZ_KFKA_DEV,OU=ServiceAccounts,OU=Azure,DC=humad,DC=com"
ldap_referral:                      "follow"
ldap_group_search_base:             "DC=humad,DC=com"
ldap_group_object_class:            "group"
ldap_group_name_attribute:          "cn"
ldap_group_member_attribute:        "member"
ldap_group_search_scope:            2
ldap_search_mode:                   "USERS"
ldap_user_search_base:              "DC=humad,DC=com"
ldap_user_search_filter:            "(|(memberOf=CN=G_Azure_C3_EEH_filtergroup_npe,OU=Groups,OU=Azure,DC=humad,DC=com))"
ldap_user_name_attribute:           "sAMAccountName"
ldap_user_memberof_attribute:       "memberOf"
ldap_user_object_class:             "user"
ldap_user_search_scope:             2
ldap_search_page_size:              1000
ldap_group_member_attribute_pattern: "CN=(.*?),.*"
ldap_user_member_attribute_pattern:  "CN=(.*?),.*"

# ------------------------------------------------------------------------------
# Azure AD / OIDC — tenant ID only (secrets are in vault_secrets.yml)
# ------------------------------------------------------------------------------
azure_tenant_id: "56c62bbe-8598-4b85-9e51-1ca753fa50f2"

# ------------------------------------------------------------------------------
# Confluent Support
# ------------------------------------------------------------------------------
confluent_support_metrics_enable: "false"
confluent_support_customer_id:    "anonymous"

# ------------------------------------------------------------------------------
# Config Provider
# ------------------------------------------------------------------------------
config_provider_class: "io.confluent.kafka.security.config.provider.SecurePassConfigProvider"

# ------------------------------------------------------------------------------
# Prometheus JMX Exporter
# ------------------------------------------------------------------------------
prometheus_jmx_exporter_enabled: true
prometheus_jmx_exporter_version: "0.20.0"
prometheus_jmx_exporter_port:    8085
prometheus_jmx_exporter_jar:     "/opt/prometheus/jmx_prometheus_javaagent-{{ prometheus_jmx_exporter_version }}.jar"
prometheus_jmx_config:           "/opt/prometheus/prometheus-config/jmx-kafka-broker-prometheus.yml"
java_agent_string:                "-javaagent:{{ prometheus_jmx_exporter_jar }}={{ prometheus_jmx_exporter_port }}:{{ prometheus_jmx_config }}"

# ------------------------------------------------------------------------------
# JVM Settings
# ------------------------------------------------------------------------------
broker_heap_opts:            "-Xmx6g -Xms6g"
broker_jvm_performance_opts: "-XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+DisableExplicitGC"

# ------------------------------------------------------------------------------
# Service
# ------------------------------------------------------------------------------
broker_service_name: "confluent-kafka"

# ------------------------------------------------------------------------------
# Restart Settings
# ------------------------------------------------------------------------------
restart_wait_time:      30
restart_max_retries:    10
restart_retry_delay:    5
broker_restart_timeout: 120

# ------------------------------------------------------------------------------
# Installation Flags
# ------------------------------------------------------------------------------
install_java:        false
configure_firewall:  false
start_broker:        true
enable_broker:       true
validate_deployment: true
create_broker_user:  true

# ------------------------------------------------------------------------------
# JFrog Artifact Repository — credentials are in vault_secrets.yml
# ------------------------------------------------------------------------------
jfrog_base_url:   "https://jfrog.example.com/artifactory"
jfrog_repo:       "confluent-local"
download_retries: 3
download_delay:   10

# ------------------------------------------------------------------------------
# Secret Variable References
# ALL secrets live in vault_secrets.yml (Ansible Vault AES256).
# configure.yml maps vault_ → plain names via set_fact (no_log: true).
# DO NOT add plain-name secret variables here — they belong in vault_secrets.yml.
# ------------------------------------------------------------------------------
